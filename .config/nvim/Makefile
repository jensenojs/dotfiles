.PHONY: help format check lint clean test install

# é»˜è®¤ç›®æ ‡
help:
	@echo "Neovim é…ç½®ç®¡ç†"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make format     - æ ¼å¼åŒ–æ‰€æœ‰ Lua æ–‡ä»¶"
	@echo "  make check      - æ£€æŸ¥æ ¼å¼ä½†ä¸ä¿®æ”¹"
	@echo "  make lint       - è¿è¡Œ luacheck æ£€æŸ¥ä»£ç è´¨é‡"
	@echo "  make clean      - æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜"
	@echo "  make test       - è¿è¡Œæµ‹è¯•"
	@echo "  make install    - å®‰è£…ä¾èµ–å·¥å…·"
	@echo "  make validate   - éªŒè¯é…ç½®æ–‡ä»¶"

# æ ¼å¼åŒ–æ‰€æœ‰ Lua æ–‡ä»¶
format:
	@echo "ğŸ¨ æ ¼å¼åŒ– Lua ä»£ç ..."
	@stylua --config-path .stylua.toml .
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

# æ£€æŸ¥æ ¼å¼ï¼ˆä¸ä¿®æ”¹ï¼‰
check:
	@echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
	@stylua --config-path .stylua.toml --check .
	@echo "âœ… æ ¼å¼æ£€æŸ¥å®Œæˆ"

# Lua ä»£ç è´¨é‡æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œ luacheck..."
	@if command -v luacheck >/dev/null 2>&1; then \
		luacheck lua/ --globals vim; \
	else \
		echo "âš ï¸  luacheck æœªå®‰è£…ï¼Œè·³è¿‡"; \
		echo "   å®‰è£…: brew install luacheck"; \
	fi

# éªŒè¯é…ç½®
validate:
	@echo "ğŸ”§ éªŒè¯ Neovim é…ç½®..."
	@nvim --headless -c "lua require('lazy').sync()" -c "qa" 2>&1 | grep -v "^$$" || true
	@echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	@find . -name "*.bak" -delete
	@find . -name "*~" -delete
	@rm -rf .tests/
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…ä¾èµ–å·¥å…·
install:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–å·¥å…·..."
	@if ! command -v stylua >/dev/null 2>&1; then \
		echo "å®‰è£… stylua..."; \
		brew install stylua; \
	fi
	@if ! command -v luacheck >/dev/null 2>&1; then \
		echo "å®‰è£… luacheck..."; \
		brew install luacheck; \
	fi
	@echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

# è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@if [ -d "test_dir" ]; then \
		nvim --headless -c "luafile test_dir/neotest_debug.lua" -c "qa"; \
	else \
		echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•ç›®å½•"; \
	fi
